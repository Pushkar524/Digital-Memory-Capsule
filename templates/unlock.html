{% extends "layout.html" %}
{% block content %}
  <section class="card">
    <div class="row">
      <div>
        <h2>Capsule #{{ capsule.id }}</h2>
        <p class="muted">Unlocked at: {{ capsule.unlock_time }}</p>
      </div>
      <a class="link" href="{{ url_for('index') }}">Back</a>
    </div>
    <form class="form" method="post" action="{{ url_for('unlock', capsule_id=capsule.id) }}" id="unlock-form">
      <label>
        Recipient email
        <input type="email" name="user_email" placeholder="recipient@example.com" required />
      </label>
      <label>
        Your key half (base64)
        <input type="text" name="user_key_half" placeholder="Paste your key half" required />
      </label>
      <button type="submit">Unlock</button>
    </form>
    {% if unlock_status == "locked" %}
      <div class="message-box" id="countdown-box" data-unlock="{{ capsule.unlock_time }}">
        <p class="muted">This capsule is still locked.</p>
        <p class="muted">Unlocks at: <span id="unlock-local">--</span></p>
        <p class="muted">Time remaining: <span id="countdown">--</span></p>
      </div>
    {% elif unlock_status == "invalid" %}
      <p class="muted">Incorrect key half. Please try again.</p>
    {% elif unlock_status == "missing" %}
      <p class="muted">Please provide your key half to continue.</p>
    {% elif unlock_status == "success" %}
      <p class="muted">Decryption successful.</p>
    {% endif %}
    {% if capsule.message %}
      <p class="message-box">{{ capsule.message }}</p>
    {% endif %}
  </section>

  {% if capsule.files %}
    <section class="card">
      <h3>Files</h3>
      <ul class="list">
        {% for file in capsule.files %}
          <li class="row">
            <div>
              <span class="mono">{{ file.filename }}</span>
              <span class="muted"> ({{ file.size }} bytes)</span>
            </div>
            <a class="link" href="{{ url_for('download_file', file_id=file.id) }}">Download</a>
          </li>
        {% endfor %}
      </ul>
    </section>
  {% endif %}

  <script>
    const countdownBox = document.getElementById("countdown-box");
    const countdownEl = document.getElementById("countdown");
    const unlockLocalEl = document.getElementById("unlock-local");
    const unlockForm = document.getElementById("unlock-form");

    if (countdownBox && countdownEl && unlockLocalEl) {
      const unlockValue = countdownBox.getAttribute("data-unlock");
      const unlockDate = new Date(unlockValue);
      unlockLocalEl.textContent = unlockDate.toLocaleString();

      const updateCountdown = () => {
        const now = new Date();
        const diff = unlockDate - now;
        if (diff <= 0) {
          countdownEl.textContent = "Ready";
          if (unlockForm) unlockForm.style.display = "grid";
          window.location.reload();
          return;
        }

        const totalSeconds = Math.floor(diff / 1000);
        const days = Math.floor(totalSeconds / 86400);
        const hours = Math.floor((totalSeconds % 86400) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        countdownEl.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;

        if (unlockForm) unlockForm.style.display = "none";
      };

      updateCountdown();
      setInterval(updateCountdown, 1000);
    }
  </script>
{% endblock %}
